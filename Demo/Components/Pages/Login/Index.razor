@page "/login"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using VRChat.API.Client
@inject NavigationManager Navigation
@inject ProtectedSessionStorage ProtectedSessionStore

<h1>Login</h1>

<EditForm Model="Model" OnSubmit="Submit" FormName="Login">
    <div>
        <label>
            Username:
            <InputText @bind-Value="Model!.Username" />
        </label>
    </div>
    <div>
        <label>
            Password:
            <InputText type="password" @bind-Value="Model!.Password" />
        </label>
    </div>
    <div>
        <button type="submit">Submit</button>
    </div>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private FormData? Model { get; set; }

    protected override void OnInitialized() => Model ??= new();

    private async void Submit() {
        var vrchat = new VRChatClientBuilder()
            .WithUsername(Model!.Username!)
            .WithPassword(Model!.Password!)
            .WithApplication(name: "ASP.NET Core VRC Auth Demo", version: "0.0.0", contact: "@6TELOIV")
            .Build();
        
        var response = await vrchat.Authentication.GetCurrentUserAsync();
        
        await ProtectedSessionStore.SetAsync("vrchat-auth-cookie", vrchat.GetCookies().First(cookie => cookie.Name == "auth").Value);
        
        if (response.RequiresTwoFactorAuth.Contains("emailOtp"))
        {
            Navigation.NavigateTo("/login/email-otp");
        }

    }

    public class FormData
    {
        public string? Username { get; set; }
        public string? Password { get; set; }
    }
}